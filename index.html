<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dwarfs | Intelligence System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-obsidian: #020408;
            --bg-surface: #0a0d12;
            --accent-primary: #3b82f6;
            --text-main: #f1f5f9;
            --border-dim: #1e293b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-obsidian);
            color: var(--text-main);
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .glass { background: rgba(10, 13, 18, 0.8); backdrop-filter: blur(20px); }

        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .animate-in {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(12px); filter: blur(4px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        #sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                width: 85%;
            }
            body.sidebar-open #sidebar {
                left: 0;
            }
            body.sidebar-open #sidebar-overlay {
                display: block;
            }
        }

        .sidebar-hidden #sidebar {
            width: 0;
            opacity: 0;
            pointer-events: none;
            border-right-width: 0;
        }

        .message-user { background: #3b82f6; color: white; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; }
        .message-model { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255,255,255,0.05); color: #e2e8f0; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; }
        
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px;
            background-color: #3b82f6; color: #3b82f6;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after { content: ""; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -12px; width: 6px; height: 6px; border-radius: 5px; background-color: #3b82f6; animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 12px; width: 6px; height: 6px; border-radius: 5px; background-color: #3b82f6; animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }

        @keyframes dot-flashing { 0% { background-color: #3b82f6; } 50%, 100% { background-color: rgba(59, 130, 246, 0.2); } }

        .vibe-chip { transition: all 0.2s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); font-size: 10px; }
        .vibe-chip.active { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); color: #3b82f6; }

        .source-link {
            display: block; padding: 8px 12px; background: rgba(255,255,255,0.03);
            border-radius: 8px; font-size: 11px; color: #94a3b8; margin-bottom: 6px;
            transition: all 0.2s; text-decoration: none; border: 1px solid rgba(255,255,255,0.05);
        }
        .source-link:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #3b82f6; transform: translateX(4px); }

        @keyframes orbit { 0% { transform: rotate(-10deg) scale(1); } 50% { transform: rotate(-5deg) scale(1.05); } 100% { transform: rotate(-10deg) scale(1); } }
        .logo-ring { animation: orbit 4s ease-in-out infinite; }

        .bg-watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 0; opacity: 0.03; pointer-events: none; width: 60vw; height: 60vw;
        }
        @media (min-width: 768px) { .bg-watermark { width: 30vw; height: 30vw; } }

        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 40; }
        
        #identity-modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(2, 4, 8, 0.9); backdrop-filter: blur(10px); }
        #identity-modal.active { display: flex; }

        #send-btn:active svg { transform: translateY(-3px) scale(1.1); }
        #send-btn svg { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .key-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s;
        }
        .key-input:focus {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="flex overflow-hidden transition-all duration-500">

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="identity-modal">
        <div class="w-full max-w-sm p-8 glass border border-white/10 rounded-3xl text-center space-y-6 animate-in">
            <div class="relative w-16 h-16 mx-auto flex items-center justify-center">
                <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center shadow-lg shadow-blue-500/20 z-10">
                    <span class="text-white font-black text-lg italic">D</span>
                </div>
            </div>
            <div class="space-y-2">
                <h3 class="text-xl font-black tracking-tight text-white uppercase">Identity Required</h3>
                <p class="text-slate-500 text-xs font-medium">Please register your name to sync with the Dwarfs Intelligence core.</p>
            </div>
            <input type="text" id="user-name-input" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-blue-500 outline-none transition-all" placeholder="Enter your name...">
            <button onclick="registerIdentity()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-black uppercase tracking-widest rounded-xl transition-all shadow-xl shadow-blue-600/20">
                Initialize Link
            </button>
        </div>
    </div>

    <aside id="sidebar" class="w-72 border-r border-dim glass flex flex-col transition-all duration-300 overflow-hidden shrink-0 h-full">
        <div class="p-6 flex flex-col h-full min-w-[18rem]">
            <div class="flex items-center justify-between mb-8 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="relative w-10 h-10 flex items-center justify-center">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-700 flex items-center justify-center shadow-lg shadow-blue-500/40 z-10">
                            <span class="text-white font-black text-sm italic">D</span>
                        </div>
                        <svg class="absolute w-12 h-12 text-blue-400/60 logo-ring" viewBox="0 0 100 100" fill="none">
                            <ellipse cx="50" cy="50" rx="45" ry="12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" transform="rotate(-25 50 50)" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <h1 class="font-black text-lg tracking-widest text-white leading-none">DWARFS</h1>
                        <span class="text-[8px] font-bold text-blue-500 tracking-[0.3em] uppercase">Intelligence</span>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll pr-2 space-y-6">
                <!-- User Profile -->
                <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">Active User</span>
                        <button onclick="showIdentityModal()" class="text-[8px] text-blue-500 font-bold hover:underline">Edit</button>
                    </div>
                    <div id="sidebar-user-name" class="text-sm font-bold text-white truncate">Guest Entity</div>
                </div>

                <!-- API Key Section -->
                <div class="p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                    <label class="text-[10px] font-black uppercase tracking-widest text-blue-500/60 mb-3 block">Neural Key (Gemini API)</label>
                    <div class="flex gap-2">
                        <input type="password" id="api-key-input" class="flex-1 key-input rounded-lg px-3 py-2 text-[11px] text-white outline-none" placeholder="Paste Key...">
                        <button onclick="saveApiKey()" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-[10px] font-black text-white transition-all uppercase">Save</button>
                    </div>
                    <p id="key-status" class="text-[8px] mt-2 font-bold uppercase tracking-tighter text-slate-500">No Key Loaded</p>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3 block">Vibe Controller</label>
                    <div class="grid grid-cols-2 gap-2" id="vibe-selector">
                        <div onclick="setVibe('professional')" class="vibe-chip active px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="professional">
                            <span>üëî</span> Prof.
                        </div>
                        <div onclick="setVibe('brainrot')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="brainrot">
                            <span>üíÄ</span> Brainrot
                        </div>
                        <div onclick="setVibe('friendly')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="friendly">
                            <span>ü§ù</span> Friendly
                        </div>
                        <div onclick="setVibe('sarcastic')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="sarcastic">
                            <span>üôÑ</span> Snarky
                        </div>
                        <div onclick="setVibe('caring')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="caring">
                            <span>üå±</span> Caring
                        </div>
                        <div onclick="setVibe('researcher')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="researcher">
                            <span>üî¨</span> Research
                        </div>
                        <div onclick="setVibe('explorer')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="explorer">
                            <span>üß≠</span> Explorer
                        </div>
                        <div onclick="setVibe('debater')" class="vibe-chip px-3 py-2 rounded-lg font-medium flex items-center gap-2 bg-white/5" data-vibe="debater">
                            <span>üó£Ô∏è</span> Debater
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3 block">History</label>
                    <div class="space-y-2" id="history-list"></div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-dim shrink-0">
                <button onclick="createNewChat(); if(window.innerWidth < 768) toggleSidebar();" class="w-full py-3 bg-white/5 border border-white/10 rounded-xl text-xs font-medium text-slate-300 hover:bg-white/10 transition-all flex items-center justify-center gap-2 mb-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Session ‚ú®
                </button>
                <div class="flex justify-between items-center text-[10px] text-slate-600 uppercase tracking-widest font-bold">
                    <span id="user-id-display">LOCAL_SYNC</span>
                    <span>V6.7_STABLE</span>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-obsidian min-w-0">
        <div class="bg-watermark flex items-center justify-center">
            <div class="relative w-full h-full flex items-center justify-center">
                <div class="w-2/3 h-2/3 rounded-full bg-blue-500 blur-[80px]"></div>
                <svg class="absolute w-full h-full text-blue-400" viewBox="0 0 100 100" fill="none">
                    <ellipse cx="50" cy="50" rx="48" ry="14" stroke="currentColor" stroke-width="1" transform="rotate(-25 50 50)" />
                    <text x="50" y="55" text-anchor="middle" font-size="20" font-weight="900" fill="currentColor" style="font-style: italic;">D</text>
                </svg>
            </div>
        </div>

        <header class="h-16 border-b border-dim flex items-center justify-between px-4 md:px-8 z-10 glass">
            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-white/5 rounded-lg transition-all text-slate-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="flex flex-col">
                    <span id="current-date" class="text-[9px] md:text-[10px] text-slate-500 font-bold tracking-tighter">---</span>
                    <span id="current-time" class="text-[10px] md:text-xs font-black text-blue-500 tracking-widest uppercase">00:00:00 AM</span>
                </div>
            </div>
            
            <div class="flex items-center gap-2 px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
                <span id="mode-status" class="text-[8px] md:text-[9px] text-emerald-500 uppercase tracking-widest font-black">Professional</span>
            </div>
        </header>

        <div id="chat-display" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 custom-scroll relative z-10">
            <div class="max-w-2xl mx-auto text-center mt-12 md:mt-32 space-y-6" id="welcome-screen">
                <div class="relative w-20 h-20 md:w-24 md:h-24 mx-auto mb-6 flex items-center justify-center">
                    <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-gradient-to-br from-blue-500 to-indigo-700 flex items-center justify-center shadow-2xl shadow-blue-500/20 z-10">
                        <span class="text-white font-black text-xl md:text-2xl italic">D</span>
                    </div>
                    <svg class="absolute w-20 h-20 md:w-24 md:h-24 text-blue-400/40 logo-ring" viewBox="0 0 100 100" fill="none">
                        <ellipse cx="50" cy="50" rx="45" ry="12" stroke="currentColor" stroke-width="2" transform="rotate(-25 50 50)" />
                    </svg>
                </div>
                <h2 class="text-2xl md:text-4xl font-black text-white tracking-tighter uppercase px-4">Beyond Intelligence.</h2>
                <p class="text-slate-400 text-xs md:text-sm max-w-md mx-auto leading-relaxed font-medium px-4">
                    The Dwarfs Neural Core is online. Local data synchronization active.
                </p>
            </div>
        </div>

        <div class="p-4 md:p-6 relative z-10">
            <div class="max-w-3xl mx-auto bg-slate-900/50 border border-dim rounded-2xl p-2 flex items-end gap-2 focus-within:border-blue-500/50 transition-all shadow-2xl backdrop-blur-md">
                <textarea id="main-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-3 px-3 resize-none outline-none text-slate-200 placeholder-slate-600" placeholder="Type a message..."></textarea>
                <button id="send-btn" onclick="executeCommand()" class="bg-blue-600 text-white h-11 w-11 md:w-auto md:px-6 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-500 transition-all flex items-center justify-center shadow-lg shadow-blue-600/20 group">
                    <span class="hidden md:inline mr-2">Ignite</span>
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" />
                        <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" />
                        <path d="M9 12H4s.5-1 1-4c1.5 0 3 .5 3 .5L12 11" />
                        <path d="M15 9s.5 1.5.5 3c3 1.5 4 1 4 1s-1-3.5-4-4.5" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        const modelName = "gemini-2.5-flash-preview-09-2025";

        let isProcessing = false;
        let currentChatId = null;
        let currentVibe = 'professional';
        let userDisplayName = "User";
        let thinkingInterval = null;

        const DB = {
            getConversations: () => JSON.parse(localStorage.getItem('dwarfs_conversations') || '[]'),
            saveConversations: (convos) => localStorage.setItem('dwarfs_conversations', JSON.stringify(convos)),
            getMessages: (chatId) => JSON.parse(localStorage.getItem(`dwarfs_msgs_${chatId}`) || '[]'),
            saveMessages: (chatId, msgs) => localStorage.setItem(`dwarfs_msgs_${chatId}`, JSON.stringify(msgs)),
            getProfile: () => JSON.parse(localStorage.getItem('dwarfs_profile') || '{"name": "Guest Entity"}'),
            saveProfile: (profile) => localStorage.setItem('dwarfs_profile', JSON.stringify(profile)),
            getApiKey: () => localStorage.getItem('dwarfs_neural_key') || '',
            saveApiKey: (key) => localStorage.setItem('dwarfs_neural_key', key)
        };

        const vibeConfig = {
            professional: { label: "Professional", instructions: "Plain text, no stars, formal, concise.", placeholder: "Awaiting inquiry..." },
            brainrot: { label: "Brainrot", instructions: "Use heavy Gen Z and Gen Alpha slang. Lots of emojis. High energy. No stars.", placeholder: "What's the tea, fam?" },
            friendly: { label: "Friendly", instructions: "Warm, polite, balanced tone. No stars.", placeholder: "How can I help today?" },
            sarcastic: { label: "Snarky", instructions: "Witty, snarky, emojis, no stars.", placeholder: "Type something stupid..." },
            caring: { label: "Caring", instructions: "Empathetic, no stars.", placeholder: "How are you feeling?" },
            researcher: { label: "Researcher", instructions: "Academic, no stars, use headers.", placeholder: "Specify parameters..." },
            explorer: { label: "Explorer", instructions: "Adventurous, no stars.", placeholder: "Where to?" },
            debater: { label: "Debater", instructions: "Critical, logical, no stars.", placeholder: "Present your argument..." }
        };

        window.saveApiKey = () => {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if(!key) return;
            DB.saveApiKey(key);
            updateKeyUI(true);
            input.value = '';
        };

        function updateKeyUI(saved = false) {
            const status = document.getElementById('key-status');
            const key = DB.getApiKey();
            if (key) {
                status.innerText = saved ? "Key Saved & Encrypted" : "Neural Link Active";
                status.classList.replace('text-slate-500', 'text-emerald-500');
            } else {
                status.innerText = "No Key Loaded";
                status.classList.replace('text-emerald-500', 'text-slate-500');
            }
        }

        window.setVibe = (vibe) => {
            currentVibe = vibe;
            document.querySelectorAll('.vibe-chip').forEach(el => el.classList.remove('active'));
            const chip = document.querySelector(`[data-vibe="${vibe}"]`);
            if (chip) chip.classList.add('active');
            document.getElementById('mode-status').innerText = vibeConfig[vibe].label;
            document.getElementById('main-input').placeholder = vibeConfig[vibe].placeholder;
        };

        async function initApp() {
            const profile = DB.getProfile();
            userDisplayName = profile.name;
            document.getElementById('sidebar-user-name').innerText = userDisplayName;
            if (userDisplayName === "Guest Entity") showIdentityModal();
            updateKeyUI();
            renderConversationsList();
            startClock();
        }

        window.showIdentityModal = () => {
            document.getElementById('identity-modal').classList.add('active');
            document.getElementById('user-name-input').value = userDisplayName === "Guest Entity" ? "" : userDisplayName;
            document.getElementById('user-name-input').focus();
        };

        window.registerIdentity = () => {
            const nameInput = document.getElementById('user-name-input');
            const name = nameInput.value.trim();
            if (!name) return;
            DB.saveProfile({ name });
            userDisplayName = name;
            document.getElementById('sidebar-user-name').innerText = name;
            document.getElementById('identity-modal').classList.remove('active');
        };

        window.toggleSidebar = () => {
            if (window.innerWidth < 768) document.body.classList.toggle('sidebar-open');
            else document.body.classList.toggle('sidebar-hidden');
        };

        function addMessageToUI(content, role, sources = []) {
            const display = document.getElementById('chat-display');
            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.remove();

            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} animate-in mb-6 w-full`;
            const box = document.createElement('div');
            box.className = `max-w-[92%] md:max-w-[85%] px-4 md:px-5 py-3 md:py-4 text-sm leading-relaxed shadow-xl ${role === 'user' ? 'message-user' : 'message-model'}`;
            box.innerHTML = content.replace(/\*/g, '').replace(/\n/g, '<br>');
            wrapper.appendChild(box);

            const uniqueSources = sources.filter(s => s.uri?.startsWith('http'));
            if (uniqueSources.length > 0) {
                const sourceContainer = document.createElement('div');
                sourceContainer.className = "mt-3 w-full max-w-[420px]";
                const details = document.createElement('details');
                details.className = "group bg-slate-900/40 border border-white/5 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm";
                const summary = document.createElement('summary');
                summary.className = "px-4 py-3 text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest cursor-pointer list-none flex items-center gap-3";
                summary.innerHTML = `<div class="w-5 h-5 rounded-lg bg-blue-500/10 flex items-center justify-center"><svg class="w-3 h-3 text-blue-400 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div> Intelligence Sources (${uniqueSources.length})`;
                const contentDiv = document.createElement('div');
                contentDiv.className = "px-3 pb-3 border-t border-white/5 pt-2 flex flex-col gap-1 max-h-48 overflow-y-auto custom-scroll";
                uniqueSources.forEach(src => {
                    const a = document.createElement('a'); a.href = src.uri; a.target = "_blank"; a.className = "source-link";
                    a.innerHTML = `<div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span><span class="truncate font-medium text-[10px]">${src.title || src.uri}</span></div>`;
                    contentDiv.appendChild(a);
                });
                details.appendChild(summary); details.appendChild(contentDiv);
                sourceContainer.appendChild(details); wrapper.appendChild(sourceContainer);
            }

            display.appendChild(wrapper);
            display.scrollTop = display.scrollHeight;
        }

        function showThinking() {
            const display = document.getElementById('chat-display');
            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.remove();
            
            const wrapper = document.createElement('div');
            wrapper.id = 'thinking-indicator';
            wrapper.className = 'flex justify-start animate-in mb-6';
            const box = document.createElement('div');
            box.className = 'px-6 py-4 message-model flex items-center gap-4 shadow-2xl bg-slate-900/60';
            
            const statuses = ["Scanning local disk...", "Querying Neural Core...", "Searching web...", "Cooking response..."];
            let idx = 0;
            
            box.innerHTML = `<div class="dot-flashing"></div><span id="thinking-text" class="text-[9px] md:text-[10px] uppercase tracking-widest font-black text-blue-400">${statuses[0]}</span>`;
            wrapper.appendChild(box);
            display.appendChild(wrapper);
            display.scrollTop = display.scrollHeight;

            thinkingInterval = setInterval(() => {
                idx = (idx + 1) % statuses.length;
                const txtEl = document.getElementById('thinking-text');
                if (txtEl) txtEl.innerText = statuses[idx];
            }, 1200);
        }

        function stopThinking() {
            if (thinkingInterval) clearInterval(thinkingInterval);
            document.getElementById('thinking-indicator')?.remove();
        }

        window.createNewChat = () => {
            const id = Date.now().toString();
            const convos = DB.getConversations();
            convos.unshift({ id, title: "New Session ‚ú®", createdAt: Date.now(), hasTitle: false });
            DB.saveConversations(convos);
            renderConversationsList();
            selectChat(id);
        };

        window.deleteChat = (chatId, e) => {
            e.stopPropagation();
            const confirmBox = document.createElement('div');
            confirmBox.className = "fixed inset-0 z-[110] flex items-center justify-center bg-black/60 backdrop-blur-sm";
            confirmBox.innerHTML = `
                <div class="glass border border-white/10 p-8 rounded-3xl max-w-xs w-full text-center space-y-6">
                    <p class="text-white text-sm font-bold uppercase tracking-widest">Terminate Session?</p>
                    <div class="flex gap-2">
                        <button id="cancel-del" class="flex-1 py-3 rounded-xl bg-white/5 text-[10px] font-black uppercase text-slate-400">Cancel</button>
                        <button id="confirm-del" class="flex-1 py-3 rounded-xl bg-red-600 text-[10px] font-black uppercase text-white shadow-lg shadow-red-600/20">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);
            document.getElementById('cancel-del').onclick = () => confirmBox.remove();
            document.getElementById('confirm-del').onclick = () => {
                const convos = DB.getConversations().filter(c => c.id !== chatId);
                DB.saveConversations(convos);
                localStorage.removeItem(`dwarfs_msgs_${chatId}`);
                if (currentChatId === chatId) { 
                    currentChatId = null; 
                    document.getElementById('chat-display').innerHTML = ''; 
                }
                renderConversationsList();
                confirmBox.remove();
            };
        };

        function selectChat(chatId) {
            currentChatId = chatId;
            document.getElementById('chat-display').innerHTML = '';
            const messages = DB.getMessages(chatId);
            messages.forEach(m => addMessageToUI(m.text, m.role, m.sources || []));
            renderConversationsList();
        }

        function renderConversationsList() {
            const list = document.getElementById('history-list');
            if (!list) return;
            list.innerHTML = '';
            const convos = DB.getConversations();
            convos.forEach(chat => {
                const container = document.createElement('div');
                container.className = `chat-item group relative flex items-center w-full rounded-xl text-xs transition-all ${currentChatId === chat.id ? 'bg-blue-600/20 text-blue-400 font-bold' : 'text-slate-500 hover:bg-white/5'}`;
                const btn = document.createElement('button'); 
                btn.className = "flex-1 text-left p-3 truncate pr-8";
                btn.innerText = chat.title || "Initial Contact";
                btn.onclick = () => { selectChat(chat.id); if(window.innerWidth < 768) toggleSidebar(); };
                const del = document.createElement('button'); 
                del.className = "absolute right-2 p-2 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity";
                del.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                del.onclick = (e) => window.deleteChat(chat.id, e);
                container.appendChild(btn); 
                container.appendChild(del);
                list.appendChild(container);
            });
        }

        async function fetchWithRetry(url, options, retries = 5) {
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    const json = await res.json();
                    if (res.ok) return json;
                    if (json.error) throw new Error(json.error.message || "Neural core rejected the link.");
                } catch (e) {
                    if (i === retries - 1) throw e;
                }
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
        }

        window.executeCommand = async () => {
            const input = document.getElementById('main-input');
            const val = input.value.trim();
            const key = DB.getApiKey();

            if(!key) {
                addMessageToUI("Error: Neural Key (API Key) missing. Please paste your Gemini API key in the sidebar settings to initialize the intelligence link.", 'model');
                return;
            }

            if(!val || isProcessing) return;
            
            if (!currentChatId) {
                const id = Date.now().toString();
                const convos = DB.getConversations();
                convos.unshift({ id, title: "New Session ‚ú®", createdAt: Date.now(), hasTitle: false });
                DB.saveConversations(convos);
                currentChatId = id;
            }

            const msgs = DB.getMessages(currentChatId);
            msgs.push({ role: 'user', text: val, timestamp: Date.now() });
            DB.saveMessages(currentChatId, msgs);
            addMessageToUI(val, 'user');
            
            input.value = ''; input.style.height = 'auto';
            isProcessing = true;
            showThinking();

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                const payload = {
                    contents: [{ parts: [{ text: val }] }],
                    systemInstruction: { parts: [{ text: `You are Dwarfs Intelligence. No stars (*). User: ${userDisplayName}. Tone: ${vibeConfig[currentVibe].instructions}. Location: Bangladesh.` }] },
                    tools: [{ "google_search": {} }]
                };

                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!data || !data.candidates || data.candidates.length === 0) {
                    throw new Error("Dwarfs core returned an empty dataset. Try rephrasing.");
                }

                const aiText = data.candidates[0].content?.parts?.[0]?.text || "Communication successful, but no text output received.";
                const sources = data.candidates[0].groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title })) || [];
                
                stopThinking();
                const updatedMsgs = DB.getMessages(currentChatId);
                updatedMsgs.push({ role: 'model', text: aiText, sources, timestamp: Date.now() });
                DB.saveMessages(currentChatId, updatedMsgs);
                addMessageToUI(aiText, 'model', sources);

                const convos = DB.getConversations();
                const currentIdx = convos.findIndex(c => c.id === currentChatId);
                if (currentIdx !== -1 && !convos[currentIdx].hasTitle) {
                    try {
                        const sumData = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Give this chat a 2-3 word title based on: "${val}". No quotes.` }] }]
                            })
                        }).then(r => r.json());
                        convos[currentIdx].title = sumData.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || val.slice(0, 15);
                        convos[currentIdx].hasTitle = true;
                        DB.saveConversations(convos);
                        renderConversationsList();
                    } catch(e) { /* silent title fail */ }
                }

            } catch (e) {
                stopThinking();
                addMessageToUI(`Core Interruption: ${e.message}. Please check your API key validity in sidebar.`, 'model');
            } finally { isProcessing = false; }
        };

        function startClock() {
            const timezone = "Asia/Dhaka";
            setInterval(() => {
                const now = new Date();
                const timeEl = document.getElementById('current-time');
                const dateEl = document.getElementById('current-date');
                if (timeEl) timeEl.innerText = now.toLocaleTimeString('en-GB', { timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }).toUpperCase();
                if (dateEl) dateEl.innerText = now.toLocaleDateString('en-GB', { timeZone: timezone, day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
            }, 1000);
        }

        window.onload = () => {
            initApp();
            document.getElementById('main-input')?.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
            document.getElementById('main-input')?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.executeCommand(); } });
            document.getElementById('user-name-input')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') window.registerIdentity(); });
        };
    </script>
</body>
</html>
